<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Canvas App Secure Page (OAuth)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fa; }
        h1 { color: #2E7D32; }
        p { color: #f2761a; }
        .hidden { display: none; }
        .blocked { color: #B71C1C; font-weight: bold; margin-top: 40px; }
        button { padding: 10px 20px; font-size: 16px; background-color: #0070d2; border: none; color: white; cursor: pointer; border-radius: 4px; margin-top: 20px; }
        button:hover { background-color: #005fb2; }
    </style>
</head>
<body>

    <div id="content" class="hidden">
        <h1>Welcome!</h1>
        <p>This content is visible to authorized Salesforce user: <span id="displayUserId"></span></p>
        <button id="loginBtn">Login to Salesforce</button>
    </div>

    <div id="blockedMessage" class="hidden blocked">
        <h1>Access Denied / Not Authorized</h1>
        <p>This content is restricted. Please authorize your Salesforce account.</p>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://login.salesforce.com/canvas/sdk/js/57.0/canvas-all.js"></script> 

    <script>
        // List of authorized Salesforce User IDs (Example)
        const allowedUserIds = ["005g5000000ujTtAAI"]; 

        function showContent(userId) {
            const trimmedUserId = userId ? userId.trim() : null;
            
            if (trimmedUserId && allowedUserIds.includes(trimmedUserId)) {
                $('#displayUserId').text(trimmedUserId); 
                $('#content').removeClass('hidden');
                $('#blockedMessage').addClass('hidden');
                console.log('Authorized user:', trimmedUserId);
            } else {
                $('#content').addClass('hidden');
                $('#blockedMessage').removeClass('hidden');
                console.log('Unauthorized user:', trimmedUserId || 'null');
            }
        }

        // --- CORE CANVAS INITIALIZATION AND AUTHORIZATION LOGIC ---
        function initCanvas() {
            if (!(window.Sfdc && Sfdc.canvas && Sfdc.canvas.client)) {
                console.log('Canvas not detected. Showing default/unauthenticated content.');
                return showContent(null);
            }
            
            const context = Sfdc.canvas.client.context || {};
            const userId = context.user ? context.user.userId : null;
            
            console.log('Initial Canvas context:', context);
            console.log('Initial UserId:', userId);

            if (userId) {
                // 1. User context is already available (e.g., after successful OAuth redirect).
                showContent(userId);
            } else {
                // 2. User context is NOT available, so initiate the OAuth flow.
                console.log('User not authorized. Initiating OAuth flow...');
                
                // ðŸš¨ FIX: Check if the function exists before calling it
                if (typeof Sfdc.canvas.client.authorize === 'function') {
                    Sfdc.canvas.client.authorize(function(response) {
                        if (response.status === 200) {
                            // Authorization successful, context should now be available.
                            const authorizedContext = Sfdc.canvas.client.context || {};
                            const authorizedUserId = authorizedContext.user ? authorizedContext.user.userId : null;
                            console.log('Authorization successful. New UserId:', authorizedUserId);
                            showContent(authorizedUserId);
                        } else {
                            // Authorization failed or denied by user
                            console.error('Authorization failed:', response);
                            showContent(null);
                        }
                    });
                } else {
                    console.error('FATAL ERROR: Sfdc.canvas.client.authorize is missing. SDK load failed or is incomplete.');
                    showContent(null);
                }
            }
            
            // Subscribe to Canvas events
            if (Sfdc.canvas.controller) {
                Sfdc.canvas.controller.subscribe({
                    name: 'openLoginExternally',
                    onData: function(event) {
                        if(event.url) window.open(event.url, '_blank');
                    }
                });
            }
        }

        // ðŸš¨ FIX: Wrap the initialization with a slight delay
        // This ensures the external canvas-all.js script has time to fully execute and define the 'authorize' function.
        $(document).ready(function() {
            setTimeout(initCanvas, 300); // 300ms delay should be sufficient
        });

        // Login button for direct access
        $('#loginBtn').on('click', function() {
            window.open('https://login.salesforce.com', '_blank');
        });
    </script>

</body>
</html>
