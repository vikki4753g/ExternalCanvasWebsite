<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Canvas App Secure Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f7fa;
        }
        h1 {
            color: #2E7D32;
        }
        p {
            color: #f2761a;
        }
        .hidden { display: none; }
        .blocked {
            color: #B71C1C;
            font-weight: bold;
            margin-top: 40px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #0070d2;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
            margin-top: 20px;
        }
        button:hover {
            background-color: #005fb2;
        }
    </style>
</head>
<body>

    <div id="content" class="hidden">
        <h1>Welcome to the Canvas App Website</h1>
        <p>This content is visible only to authorized Salesforce users.</p>
        <button id="loginBtn">Login to Salesforce</button>
    </div>

    <div id="blockedMessage" class="hidden blocked">
        <h1>Access Denied</h1>
        <p>Your Salesforce UserId is not authorized to view this content.</p>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script src="https://login.salesforce.com/canvas/sdk/js/57.0/canvas-all.js"></script>

    <script>
        // Allowed Salesforce users
        const allowedUserIds = [
            "005NS00000HHuDhYAL"
        ];

        // Hide all initially
        $('#content').addClass('hidden');
        $('#blockedMessage').addClass('hidden');

        function checkAccess(userId) {
            console.log("Checking access for User:", userId);

            if (userId && allowedUserIds.includes(userId.trim())) {
                $('#content').removeClass('hidden');
                $('#blockedMessage').addClass('hidden');
            } else {
                $('#content').addClass('hidden');
                $('#blockedMessage').removeClass('hidden');
            }
        }

        // Main Canvas authentication logic
        function initCanvas() {
            console.log("Canvas object:", window.Sfdc);

            if (window.Sfdc && Sfdc.canvas && Sfdc.canvas.client) {
                console.log("Canvas detected, getting signed request...");

                Sfdc.canvas.client.refreshSignedRequest(function (data) {
                    console.log("Signed request data:", data);

                    if (data && data.context && data.context.user && data.context.user.userId) {
                        // SUCCESS: User authenticated
                        const userId = data.context.user.userId;
                        console.log("Canvas UserId:", userId);
                        checkAccess(userId);
                    } else {
                        console.log("No signedRequest found → starting OAuth flow");

                        const clientId = "3MVG9VMBZCsTL9hkWQ1BrPa_bs34VIUTXdM8vYAAszdjFeq0Dtk8yldxDQM4_q.XqCGUJuPmwEv0lGQJZpgpK";

                        const callbackUrl = encodeURIComponent("https://vikki4753g.github.io/ExternalCanvasWebsite/callback.html");

                        const authUrl =
                            "https://cloudanalogy-4c0-dev-ed.develop.my.salesforce.com/services/oauth2/authorize" +
                            "?client_id=" + clientId +
                            "&response_type=token" +
                            "&redirect_uri=" + callbackUrl;

                        console.log("Redirecting user to OAuth:", authUrl);

                        window.top.location.href = authUrl;
                    }
                });

            } else {
                // Not inside Canvas — allow free access in browser
                console.log("Not inside Canvas → Direct Browser Mode");
                $('#content').removeClass('hidden');
                $('#blockedMessage').addClass('hidden');
            }
        }

        // Run auth logic
        initCanvas();

        // Button login handling
        $('#loginBtn').on('click', function() {
            window.open('https://login.salesforce.com', '_blank');
        });
    </script>

</body>
</html>
